<!DOCTYPE html>


<html>
<head>
    <meta charset="utf-8">
    <title>beautiful dream</title>
    <!-- 引入 echarts.js -->

    <link rel="icon" href="https://photosfor2018.oss-cn-hangzhou.aliyuncs.com/dreamforfuture.png">
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
    <script src="/v1/echart.js"></script>
    <!-- <script src="https://cdn.bootcss.com/echarts/4.2.1/echarts-en.common.js"></script> -->
    <!-- <script src="https://cdn.bootcss.com/echarts/4.0.2/echarts-en.common.js"></script> -->
   
</head>
<script>
    jQuery.ajaxSetup({async:false});
    // Set the date we're counting down to
    var countDownDate = new Date("Jan 5, 2019 15:37:25").getTime();
    
    // Update the count down every 1 second
       var x = setInterval(function() {
    
        // Get todays date and time
        var now = new Date();
        
        // Find the distance between now and the count down date
        var distance = countDownDate - now;
        
        // Time calculations for days, hours, minutes and seconds
        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);
        var hour = now.getHours();
        var stringhour =  hour.toString();
        if (stringhour.length<2){
            stringhour = "0" + stringhour;
        }
    
        
    
        var minutes = now.getMinutes();
    
         var stringminutes =  minutes.toString();
        if (stringminutes.length<2){
            stringminutes = "0" + stringminutes;
        }
    
    
        var seconds = now.getSeconds();
    
           var stringseconds =  seconds.toString();
        if (stringseconds.length<2){
            stringseconds = "0" + stringseconds;
        }
    
    
    
        // Output the result in an element with id="demo"
        //document.getElementById("demo").innerHTML = days + "d " + hours + "h "
        //+ minutes + "m " + seconds + "s ";
        
        document.getElementById("demo").innerHTML = stringhour +":"+stringminutes+":"+stringseconds+"s";
    
        // If the count down is over, write some text 
        // if (distance < 0) {
        //     clearInterval(x);
        //     document.getElementById("demo").innerHTML = "EXPIRED";
        // }
    }, 1000);
    
    
    </script>
<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div>
        <button id = "noproject">no project level</button><button id="withproject" >project level</button>
            
   <div id="chart" style="position: absolute;left:0;right:0;top:40px;bottom:0;">
    <div id="time" style="width: 3000px;height:200px;">
        <ul id="demo"></ul>
    </div>
    <div id="main" style="width: 3000px;height:3000px;"></div>
    <script type="text/javascript">
     // 基于准备好的dom，初始化echarts实例 http://echarts.baidu.com/examples/#chart-type-treemap
       
//myChart.showLoading();
// myChart.hideLoading();
        // 指定图表的配置项和数据
/*        var option = {
            title: {
                text: 'ECharts 入门示例'
            },
            tooltip: {},
            legend: {
                data:['销量']
            },
            xAxis: {
                data: ["衬衫","羊毛衫","雪纺衫","裤子","高跟鞋","袜子"]
            },
            yAxis: {},
            series: [{
                name: '销量',
                type: 'bar',
 data: [5, 20, 36, 10, 10, 20]
}]
};

// 使用刚指定的配置项和数据显示图表。
myChart.setOption(option);
*/
//myChart.showLoading();
//$.get('data/asset/data/flare.json', function (data) {
//myChart.hideLoading();

   jQuery.ajaxSetup({async:false});
   var myChart = echarts.init(document.getElementById('main'));
  function  getgoaltrees(){
    projectsfortree = []
    $.get("/v1/goalsgraph", function(data, status){
    var datafromserver = data
    //console.log(indicators.hist)
    //projects = datafromserver.projects
    goals = datafromserver.goals
    // histv = indicators.hist
    // signalv = indicators.signal
    // kdjkv =  indicators.kdjk
    // kdjdv =  indicators.kdjd
    // kdjjv =  indicatof       rs.kdjj



    single_goal_projects = []
    for(j=0;j<goals.length;j++){
        console.log("--------")
    //macdvalue.push(projects[i])
   
    projectsfortree = []
    for(i=0;i<goals[j].Allprojectsingoal.length;i++){
     var allprojects = goals[j].Allprojectsingoal
     singleproject_tasks = []
     for(k=0;k<allprojects[i].Alltasksinproject.length;k++){
        var alltasks = allprojects[i].Alltasksinproject
        singleproject_tasks.push({"name":alltasks[k].task +"-"+alltasks[k].ID.toString(),"value":223})
     }
     projectsfortree.push({"name":allprojects[i].Name,"children":singleproject_tasks})
     
    //singleproject_tasks.push({"name":alltasks[i].task +"-"+alltasks[i].ID.toString(),"value":223})
    }

    single_goal_projects.push({"name":goals[j].Name,"children":projectsfortree})

    }
   })
return single_goal_projects
}

function  getgoaltrees_without_project(){
    goalsfortree = []
    $.get("/v1/goalsgraph?type=noproject", function(data, status){
    var datafromserver = data
    //console.log(indicators.hist)
    goals = datafromserver.goals
    //projects = datafromserver.projects
    // histv = indicators.hist
    // signalv = indicators.signal
    // kdjkv =  indicators.kdjk
    // kdjdv =  indicators.kdjd
    // kdjjv =  indicatof       rs.kdjj

    for(j=0;j<goals.length;j++){
        console.log("--------")
    //macdvalue.push(projects[i])
    singlegoal_tasks = []
    for(i=0;i<goals[j].Alltasksingoal.length;i++){
     var alltasks = goals[j].Alltasksingoal
      singlegoal_tasks.push({"name":alltasks[i].task +"-"+alltasks[i].ID.toString(),"value":223})
    }
    goalsfortree.push({"name":goals[j].Name,"children":singlegoal_tasks})
    }
   })
return goalsfortree
}

var heartCheck = {
    timeout: 6000,//60ms
    timeoutObj: null,
    ws:null,
    serverTimeoutObj: null,
    reset: function(){
        clearTimeout(this.timeoutObj);
        clearTimeout(this.serverTimeoutObj);
　　　　 this.start();
    },
    start: function(){
        //alert(this.ws)
        var self = this;
        this.timeoutObj = setTimeout(function(){
        console.log("------我在这里测试心跳-----------")
        // alert(self.ws)
        console.log("------我在这里测试心跳-----------")
        self.ws.send("HeartBeat");
        self.serverTimeoutObj = setTimeout(function(){
        self.ws.close();//如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次
            }, self.timeout)
        }, this.timeout)
    },
}





function connect(url) {
  var ws = new WebSocket(url);
  
//   ws.binaryType = 'arraybuffer';
  ws.onopen = function() {
    //alert(ws)
    heartCheck.ws = ws;
    // alert(heartCheck.ws)
    heartCheck.start()
    // subscribe to some channels
    console.log("发送数据到服务器进行测试")
    ws.send("Message to send");
    console.log("发送数据到服务器进行测试")
    // ws.send(JSON.stringify({
    //   "a":1
    //     //.... some message the I must send when I connect ....
    // }));
  };

  ws.onmessage = function(e) {
    heartCheck.reset();
    console.log('Message:', e.data);
    if (e.data =="服务器发送图像数据到前端"){
     var data = {"name":"goals","children":getgoaltrees()}
     doooo(data)
    }
   
    // var data = new Uint8Array(e.data);
    // player.feed(data);
    
  };
  
  
  ws.onclose = function(e) {
    console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
    setTimeout(function() {
    // connect('ws://localhost:777');
    // connect('ws://47.100.100.141:777');
    connect('ws://localhost:777');
    }, 1000);
  };

  ws.onerror = function(err) {
    console.error('Socket encountered error: ', err.message, 'Closing socket');
    ws.close();
  };
}


// connect('ws://47.100.100.141:777')
   connect('ws://localhost:777')








var data = {"name":"goals","children":getgoaltrees()}
doooo(data)
$( "#noproject" ).click(function() {
//   alert( "Handler for .click() called." );
//   //var myNode = document.getElementById("foo");
// while (myChart.firstChild) {
//     myChart.removeChild(myNode.firstChild);
// }
//   //var data1 = {"name":"goals","children":getgoaltrees_without_project()}
//   doooo(data)
window.location.reload();
});


$( "#withproject" ).click(function() {
  var data2 = {"name":"goals","children": getgoaltrees()}
  doooo(data2)
});


//var data = {"name":"goals","children":getgoaltrees()}

/*
    echarts.util.each(data.children, function (datum, index) {
        index % 2 === 0 && (datum.collapsed = true);
    });

    myChart.setOption(option = {
        tooltip: {
            trigger: 'item',
            triggerOn: 'mousemove'
        },
        series: [
            {
                type: 'tree',

                data: [data],

                top: '2%',
                left: '7%',
                bottom: '1%',
                right: '20%',

                symbolSize: 7,

                label: {
                    normal: {
                        position: 'left',
                        verticalAlign: 'middle',
                        align: 'right',
                        fontSize: 15
                    }
                },

                leaves: {
                    label: {
                        normal: {
                            position: 'right',
                            verticalAlign: 'middle',
                            align: 'left'
                        }
                    }
                },

                expandAndCollapse: true,
                animationDuration: 550,
                animationDurationUpdate: 750
            }
        ]
    });
*/

function doooo(datafromserver){
    

    myChart.setOption(
       

        
//从左到右的方式
//         option = {
//     tooltip: {
//         trigger: 'item',
//         triggerOn: 'mousemove'
//     },
//     series:[
//         {
//             type: 'tree',
//             id: 0,
//             name: 'tree1',
//             data: [datafromserver],

//             top: '10%',
//             left: '8%',
//             bottom: '22%',
//             right: '20%',

//             symbolSize: 7,

//             edgeShape: 'polyline',
//             edgeForkPosition: '63%',
//             initialTreeDepth: 3,

//             lineStyle: {
//                 width: 2
//             },

//             label: {
//                 backgroundColor: '#fff',
//                 position: 'left',
//                 verticalAlign: 'middle',
//                 align: 'right'
//             },

//             leaves: {
//                 label: {
//                     position: 'right',
//                     verticalAlign: 'middle',
//                     align: 'left'
//                 }
//             },

//             expandAndCollapse: true,
//             animationDuration: 550,
//             animationDurationUpdate: 750
//         }
//     ]
// }



        option = {
    tooltip: {
        trigger: 'item',
        triggerOn: 'mousemove'
    },
    series: [
        {
            type: 'tree',
            data: [datafromserver],

            top: '18%',
            bottom: '14%',

            layout: 'radial',

            symbol: 'pin',

            symbolSize: 10,

            initialTreeDepth: 3,
            rom:true,
            emphasis:{
                lineStyle:{width:20}
            },
            label:{show:true,position:"right",rotate:12,fontStyle:'italic',fontSize:15},
            lineStyle:{width:1,color:"red",curveness:0.1},
            animationDurationUpdate: 750
            
                // top: '1%',
                // left: '15%',
                // bottom: '1%',
                // right: '7%',

                // symbolSize: 7,

                // orient: 'RL',

                // label: {
                //     position: 'right',
                //     verticalAlign: 'middle',
                //     align: 'left'
                // },

                // leaves: {
                //     label: {
                //         position: 'left',
                //         verticalAlign: 'middle',
                //         align: 'right'
                //     }
                // },

                // expandAndCollapse: true,
                // animationDuration: 550,
                // animationDurationUpdate: 750


        }
    ]

}





);
}



</script>
</body>
</html>
